---
buildPack: docker
pipelineConfig:
  pipelines:
    release:
      setVersion:
        replace: true
        steps:
          - image: gcr.io/jenkinsxio/builder-maven
            steps:
              - name: fetch-history
                sh: git fetch --unshallow
              - name: create-version-file
                sh: jx step next-version --version=$(make version~print)
              - name: tag-version
                sh: jx step tag
      build:
        steps:
          - name: container-build
            image: gcr.io/kaniko-project/executor
            sh: >-
              /kaniko/executor --cache=true --cache-dir=/workspace
              --context=/workspace/source
              --dockerfile=/workspace/source/Dockerfile
              --destination=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/$APP_NAME:$VERSION
              --cache-repo=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/cache
      promote:
        steps:
          - name: promote-to-jxl
            sh: >-
              jx step create pr regex
              --repo https://github.com/nuxeo/jxlabs-nos-jxl.git
              --version=${VERSION}
              --regex="^FROM gcr.io/build-jx-prod/jxlabs-nos-master/jxlabs-nos-jxl-base-image:(?P<version>.*)$"
              --files=Dockerfile
          - name: promote-to-helmfile
            sh: >-
              jx step create pr regex
              --repo=https://github.com/nuxeo/nos-helmfile
              --version=${VERSION}
              --regex="^helmfile-version := (?P<version>.*)$"
              --files=Makefile
